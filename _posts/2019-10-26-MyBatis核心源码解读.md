---
layout:     post
title:      MyBatisæ ¸å¿ƒæºç è§£è¯»
subtitle:   MyBatisæ ¸å¿ƒæºç è§£è¯»(ğŸ™ˆğŸ™ŠğŸ™‰)
date:       2019-10-26
author:     BY
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - MyBatis
    - Java
---
## ä¸€ã€å…ˆçŸ¥æ™“å‡ ä¸ªç±»

æ¯ä¸ªåŸºäºMyaBatisçš„åº”ç”¨éƒ½æ˜¯ä»¥"ä¸€ä¸ª"SqlSessionFactoryå®ä¾‹ä¸ºæ ¸å¿ƒå’ŒåŸºç¡€çš„ï¼Œè€ŒSqlSessionFactoryæ˜¯ç”±SqlSessionFactoryBuilderåˆ›å»ºçš„ï¼Œè€Œ SqlSessionFactoryBuilder åˆ™å¯ä»¥ä» XML é…ç½®æ–‡ä»¶æˆ–ä¸€ä¸ªé¢„å…ˆå®šåˆ¶çš„ Configuration çš„å®ä¾‹æ„å»ºå‡º SqlSessionFactory çš„å®ä¾‹ã€‚

1ã€SqlSessionFactoryBuilderï¼ˆå¥³å¨²ï¼‰

è¿™ä¸ªç±»å¯ä»¥è¢«å®ä¾‹åŒ–ã€ä½¿ç”¨å’Œä¸¢å¼ƒï¼Œä¸€æ—¦åˆ›å»ºäº† SqlSessionFactoryï¼Œå°±ä¸å†éœ€è¦å®ƒäº†ã€‚ å› æ­¤ SqlSessionFactoryBuilder å®ä¾‹çš„æœ€ä½³ä½œç”¨åŸŸæ˜¯æ–¹æ³•ä½œç”¨åŸŸï¼ˆä¹Ÿå°±æ˜¯å±€éƒ¨æ–¹æ³•å˜é‡ï¼‰ã€‚ ç”¨SqlSessionFactoryBuilder å¯ä»¥åˆ›å»ºå¤šä¸ª SqlSessionFactory å®ä¾‹ã€‚

2ã€SqlSessionFactoryï¼ˆå¥¶å¦ˆï¼‰

SqlSessionFactory ä¸€æ—¦è¢«åˆ›å»ºå°±åº”è¯¥åœ¨åº”ç”¨çš„è¿è¡ŒæœŸé—´ä¸€ç›´å­˜åœ¨ï¼Œä¸èƒ½ä¸¢å¼ƒå®ƒæˆ–é‡æ–°åˆ›å»ºå¦ä¸€ä¸ªSqlSessionFactoryå®ä¾‹ã€‚ SqlSessionFactory åœ¨åº”ç”¨è¿è¡ŒæœŸé—´ä¸è¦é‡å¤åˆ›å»ºå¤šæ¬¡ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯å¼€å¯ä¸€ä¸ªSqlSessionï¼Œç”¨æˆ·ç›´æ¥ä¸SqlSessionæ‰“äº¤é“ã€‚

3ã€SqlSessionï¼ˆæ°è¥¿ï¼Œå¥¶å¦ˆ de å­©å­ï¼‰

SqlSession å®Œå…¨åŒ…å«äº†é¢å‘æ•°æ®åº“æ‰§è¡Œ SQL å‘½ä»¤æ‰€éœ€çš„æ‰€æœ‰æ–¹æ³•ã€‚ä½ å¯ä»¥é€šè¿‡ SqlSession å®ä¾‹æ¥ç›´æ¥æ‰§è¡Œå·²æ˜ å°„çš„ SQL è¯­å¥ã€‚
```
try (SqlSession session = sqlSessionFactory.openSession()) {
  Author author = (Author) session.selectOne("org.mybatis.example.AuthorMapper.selectAutor", 1);
}
```
æ›´ç®€æ´çš„æ–¹å¼ â€”â€”ä½¿ç”¨æè¿°æ¯ä¸ªè¯­å¥çš„å‚æ•°å’Œè¿”å›å€¼çš„æ¥å£ï¼Œä¸ä»…å¯ä»¥æ‰§è¡Œæ›´æ¸…æ™°å’Œç±»å‹å®‰å…¨çš„ä»£ç ï¼Œè€Œä¸”è¿˜ä¸ç”¨æ‹…å¿ƒæ˜“é”™çš„å­—ç¬¦ä¸²å­—é¢å€¼ä»¥åŠå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚

```
try (SqlSession session = sqlSessionFactory.openSession()) {
  AuthorMapper mapper = session.getMapper(AuthorMapper.class);
  Author author = mapper.selectBlog(101);
}
```


**ç¡®ä¿ SqlSession å…³é—­çš„æ ‡å‡†æ¨¡å¼ï¼š**
```
// æ¥å£SqlSession ç»§æ‰¿äº†Closeableæ¥å£ï¼Œå¯ä»¥ä½¿ç”¨Java7 çš„ try-with-resourcesè¯­æ³•æ¥ä¿è¯sessionçš„å…³é—­
try (SqlSession session = sqlSessionFactory.openSession()) {
  // just do it 
}
```
ä¸Šé¢çš„ä»‹ç»çš„å¾ˆé‡è¦ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½æºç çš„"å¤´"ï¼Œä»¥ä¾¿æˆ‘ä»¬è¿›è¡Œé˜…è¯»æºç ã€‚

## äºŒã€é…ç½®

å¯ä»¥é€šè¿‡XMLæ–‡ä»¶æ–¹å¼å’Œä»£ç æ–¹å¼æ„å»ºSqlSessionFactoryï¼Œä¸ªäººå»ºè®®é€šè¿‡XMLæ–‡ä»¶æ–¹å¼è¿›è¡Œæ„å»ºï¼Œç®€å•ã€ç›´è§‚ã€æ˜äº†
![é…ç½®æ–‡ä»¶.png](https://upload-images.jianshu.io/upload_images/7190871-1f07cc7d91dffc5b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


## ä¸‰ã€ä½¿ç”¨
```
    // é…ç½®æ–‡ä»¶è·¯å¾„
    String resource = "org/apache/ibatis/builder/MapperConfig.xml";
    /*
     * Resourcesä½œç”¨ï¼šé€šè¿‡ç±»åŠ è½½å™¨ç®€åŒ–å¯¹èµ„æºè®¿é—®çš„ç±»ã€‚
     * è¯»å–é…ç½®æ–‡ä»¶å†…å®¹ï¼Œè¿”å›æµ
     */
    InputStream inputStream = Resources.getResourceAsStream(resource);
    // è§£æå¹¶æ„å»ºå‡ºSqlSessionFactory
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
    // SqlSessionå®ç°äº†Closeableæ¥å£
    try(SqlSession sqlSession = sqlSessionFactory.openSession()) {
        // å®é™…ä¸Šè·å–åˆ°çš„æ˜¯ä¸€ä¸ªé€šè¿‡ä»£ç†å¯¹è±¡
        AuthorMapper authorMapper = sqlSession.getMapper(AuthorMapper.class);
        // æ‰§è¡ŒæŸ¥è¯¢sqlï¼Œå¹¶è¿›è¡Œç»“æœé›†æ˜ å°„
        List<E> list = author.getAuthors();
    }
```
ä¸Šè¿°ä»£ç ï¼Œå°±æ˜¯ä½¿ç”¨MyBatisæŸ¥è¯¢æ•°æ®åº“æŸä¸ªè¡¨ï¼Œå¹¶è¿”å›ç»“æœåˆ—è¡¨çš„è¿‡ç¨‹ï¼Œå¢åˆ æ”¹ä¸€æ ·çš„é“ç†ã€‚åœ¨è¿”å›ç»“æœé›†åï¼ŒsqlSessionè°ƒç”¨close()æ–¹æ³•ï¼Œå…³é—­è¿™ä¸ªsessionã€‚

å¤§å®¶å¯èƒ½ä¼šè§‰å¾—è¿™å¥—é…ç½®åŠä½¿ç”¨æ€ä¹ˆå’Œç°æœ‰å·¥ç¨‹ä¸ä¸€æ ·ï¼Œé‚£æ˜¯å› ä¸ºåœ¨ç°æœ‰å·¥ç¨‹é‡Œæˆ‘ä»¬ä½¿ç”¨äº†MyBatis-Springã€‚å…³äºMyBatis-Springåœ¨è¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹ä¸€ä¸‹MyBatis-Springçš„æ–‡æ¡£åŠæºç ï¼ŒåŸºæœ¬ä¸Šå’Œæˆ‘ä»¬è¦æŠŠMyBatisèå…¥åˆ°Springçš„æ€è·¯å·®ä¸å¤ªå¤šã€‚

## å››ã€å¼€å§‹å‰¥æ´‹è‘±
### 1ã€ä»`SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream)`å¼€å§‹è§£è¯»ã€‚
`SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream)`
è¿™è¡Œä»£ç çš„æ„æ€æ˜¯é€šè¿‡SqlSessionFactoryBuilderåˆ›å»ºä¸€ä¸ªSqlSessionFactoryï¼Œè€Œbuildå…·ä½“çš„å†…éƒ¨åˆ›å»ºç»†èŠ‚å¦‚ä¸‹ï¼š
```
public class SqlSessionFactoryBuilder {        
          /*
           * â‘  åœ¨è¿™é‡Œï¼Œå†…éƒ¨è°ƒç”¨äº†build(InputStream inputStream, String environment, Properties properties)æ–¹æ³•
           */
          public SqlSessionFactory build(InputStream inputStream) {
            return build(inputStream, null, null);
          }

          /*
           * â‘¡
           * æ–‡ä»¶æµã€ç¯å¢ƒé…ç½®ã€å±æ€§ï¼Œåä¸¤è€…éƒ½ä¸ºnullï¼Œæœ‰å¯èƒ½åœ¨MyBatisé…ç½®æ–‡ä»¶ä¸­æœ‰å®šä¹‰
           */
          public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) {
            try {
              /*
               * XMLé…ç½®æ„å»ºå™¨ è¿™æ ·çš„å†™æ³•æ£’æ£’å“’ï¼Œé€»è¾‘æ¸…æ™°æ˜äº†ï¼Œæœ‰ç‚¹ç±»ä¼¼
               */
              XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);
              /*
               * parser.parse() è¿”å›MyBatisæœ€é‡è¦çš„ä¸€ä¸ªé…ç½®ç±» Configurationï¼Œä½œä¸ºDefaultSqlSessionFactoryæ„é€ å‡½æ•°çš„å‚æ•°ä¼ é€’è¿›å»ï¼Œè¿›è¡ŒDefaultSqlSessionFactoryçš„å®ä¾‹åŒ–
               */
              return build(parser.parse());
            } catch (Exception e) {
              throw ExceptionFactory.wrapException("Error building SqlSession.", e);
            } finally {
              ErrorContext.instance().reset();
              try {
                inputStream.close();
              } catch (IOException e) {
                // Intentionally ignore. Prefer previous error.
              }
            }
          }
        
          /*
           * åˆ›å»ºSqlSessionFactory
           */
          public SqlSessionFactory build(Configuration config) {
            return new DefaultSqlSessionFactory(config);
          }
        
        }
```
æ ¸å¿ƒè§£æä»£ç åœ¨XMLConfigBuilder.parse()æ–¹æ³•é‡Œï¼Œç”±å®ƒè§£æå‡ºConfigurationå®ä¾‹ã€‚XMLConfigBuilderçš„parseä»£ç å¦‚ä¸‹ï¼š
```
XMLConfigBuilder:
    public Configuration parse() {
        // åªèƒ½è§£æä¸€æ¬¡ å¦åˆ™å¤šæ¬¡è§£æä¼šæ‰“ä¹±é…ç½®ä¿¡æ¯ã€‚è€Œä¸”å¤šæ¬¡è§£ææœ¬èº«å°±æ˜¯ä¸€ç§é”™è¯¯
        if (parsed) {
          throw new BuilderException("Each XMLConfigBuilder can only be used once.");
        }    
        // å°†è§£ææ ‡è¯†ç½®ä¸ºtrueï¼Œé˜²æ­¢äºŒæ¬¡è§£æ
        parsed = true;
        // å†…éƒ¨ç§æœ‰æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è¿›è¡Œé…ç½®è§£æï¼Œè§£æç›®æ ‡èŠ‚ç‚¹ä¸º<configuration>.....</configuration>
        parseConfiguration(parser.evalNode("/configuration"));
        return configuration;
      }
```
`parseConfiguration(parser.evalNode("/configuration"));` å†…éƒ¨ç§æœ‰æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è¿›è¡Œé…ç½®è§£æã€‚

```
XMLConfigBuilder:
      // è§£æé…ç½®
      private void parseConfiguration(XNode root) {
        try {
    
          // #è§£æå­èŠ‚ç‚¹properties
          // issue #117 read properties first
          // è¿™äº›å±æ€§éƒ½æ˜¯å¯å¤–éƒ¨é…ç½®ä¸”å¯åŠ¨æ€æ›¿æ¢çš„ï¼Œæ—¢å¯ä»¥åœ¨å…¸å‹çš„ Java å±æ€§æ–‡ä»¶ä¸­é…ç½®ï¼Œäº¦å¯é€šè¿‡ properties å…ƒç´ çš„å­å…ƒç´ æ¥ä¼ é€’
          propertiesElement(root.evalNode("properties"));
    
          // mybatisä¸­å¾ˆé‡è¦çš„é…ç½®
          Properties settings = settingsAsProperties(root.evalNode("settings"));
          loadCustomVfs(settings);
          loadCustomLogImpl(settings);
    
          // #è§£æå­èŠ‚ç‚¹typeAliases åˆ«å
          // ç±»å‹åˆ«åæ˜¯ä¸º Java ç±»å‹è®¾ç½®ä¸€ä¸ªçŸ­çš„åå­—ã€‚ å®ƒåªå’Œ XML é…ç½®æœ‰å…³ï¼Œå­˜åœ¨çš„æ„ä¹‰ä»…åœ¨äºç”¨æ¥å‡å°‘ç±»å®Œå…¨é™å®šåçš„å†—ä½™ã€‚
          typeAliasesElement(root.evalNode("typeAliases"));
          // #è§£æå­èŠ‚ç‚¹plugins æ’ä»¶
          pluginElement(root.evalNode("plugins"));
          // #è§£æå­èŠ‚ç‚¹objectFactory mybatisä¸ºç»“æœåˆ›å»ºå¯¹è±¡æ—¶éƒ½ä¼šç”¨åˆ°objectFactory
          objectFactoryElement(root.evalNode("objectFactory"));
          // #è§£æå­èŠ‚ç‚¹objectWrapperFactory
          objectWrapperFactoryElement(root.evalNode("objectWrapperFactory"));
          // 3.3.0ä¹‹å‰ä¸éœ€è¦ æœ‰é»˜è®¤å®ç°
          /*
            Reflector è¿™ä¸ªç±»çš„ç”¨é€”ä¸»è¦æ˜¯æ˜¯é€šè¿‡åå°„è·å–ç›®æ ‡ç±»çš„ getter æ–¹æ³•åŠå…¶è¿”å›å€¼ç±»å‹ï¼Œsetter æ–¹æ³•åŠå…¶å‚æ•°å€¼ç±»å‹ç­‰å…ƒä¿¡æ¯ã€‚å¹¶å°†è·å–åˆ°çš„å…ƒä¿¡æ¯ç¼“å­˜åˆ°ç›¸åº”çš„é›†åˆä¸­ï¼Œä¾›åç»­ä½¿ç”¨
           */
          reflectorFactoryElement(root.evalNode("reflectorFactory"));
          settingsElement(settings);
          // #è§£æenvironments å¯ä»¥é…ç½®å¤šä¸ªè¿è¡Œç¯å¢ƒï¼Œä½†æ˜¯æ¯ä¸ªSqlSessionFactory å®ä¾‹åªèƒ½é€‰æ‹©ä¸€ä¸ªè¿è¡Œç¯å¢ƒ
          // read it after objectFactory and objectWrapperFactory issue #631
          environmentsElement(root.evalNode("environments"));
          // #è§£ædatabaseIdProvider MyBatisèƒ½å¤Ÿæ‰§è¡Œä¸åŒçš„è¯­å¥å–å†³äºä½ æä¾›çš„æ•°æ®åº“ä¾›åº”å•†ã€‚è®¸å¤šæ•°æ®åº“ä¾›åº”å•†çš„æ”¯æŒæ˜¯åŸºäºdatabaseIdæ˜ å°„
          databaseIdProviderElement(root.evalNode("databaseIdProvider"));
          // #è§£ætypeHandlers å½“MyBatisè®¾ç½®å‚æ•°åˆ°PreparedStatement æˆ–è€…ä»ResultSet ç»“æœé›†ä¸­å–å¾—å€¼æ—¶ï¼Œå°±ä¼šä½¿ç”¨TypeHandler  æ¥å¤„ç†æ•°æ®åº“ç±»å‹ä¸java ç±»å‹ä¹‹é—´è½¬æ¢
          typeHandlerElement(root.evalNode("typeHandlers"));
          // #è§£æmappers ä¸»è¦çš„crudæ“ä½œéƒ½æ˜¯åœ¨mappersä¸­å®šä¹‰çš„ï¼Œè¿™ä¸ªæ˜¯ä¸»çº¿ï¼Œç»§ç»­å¾€ä¸‹èµ°
          mapperElement(root.evalNode("mappers"));
        } catch (Exception e) {
          throw new BuilderException("Error parsing SQL Mapper Configuration. Cause: " + e, e);
        }
      }
```
åœ¨è§£æmapperElementæ–¹æ³•ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹<mappers>çš„é…ç½®æ–¹å¼ï¼š
```
<mappers>
  // â‘  æ‰«æè¯¥ç›®å½•åŒ…ä¸‹æ‰€æœ‰mapperæ¥å£ xmlæ–‡ä»¶å¿…é¡»åœ¨åŒä¸€ç›®å½•
  <package name="org.mybatis.builder"></package>
  // â‘¡ ä½¿ç”¨ç›¸å¯¹classpathçš„è·¯å¾„
  <mappers resource="org/mybatis/builder/AuthorMapper.xml"></mapper>
  // â‘¢ ä½¿ç”¨å®Œå…¨é™å®šèµ„æºå®šä½ç¬¦ï¼ˆURLï¼‰
  <mappers url="file:///var/mappers/AuthorMapper.xml"></mapper>
  // â‘£ ä½¿ç”¨æ˜ å°„å™¨æ¥å£å®ç°ç±»çš„å®Œå…¨é™å®šå å¦‚æœæ²¡æœ‰ä½¿ç”¨æ³¨è§£ï¼Œé‚£ä¹ˆxmlæ–‡ä»¶å¿…é¡»åœ¨åŒä¸€ç›®å½•
  <mappers class="org.mybatis.builder.AuthorMapper"></mapper>
</mappers>
```
ä»¥ä¸Šå››ç§å½¢å¼åªèƒ½é€‰æ‹©å…¶ä¸­ä¸€ç§ã€‚
åœ¨mapperElementæ–¹æ³•é‡Œï¼Œæ˜¯è¿™æ ·è§£æçš„ï¼š
```
private void mapperElement(XNode parent) throws Exception {
    if (parent != null) {
      for (XNode child : parent.getChildren()) {
        if ("package".equals(child.getName())) {
          String mapperPackage = child.getStringAttribute("name");
          configuration.addMappers(mapperPackage);
        } else {
          String resource = child.getStringAttribute("resource");
          String url = child.getStringAttribute("url");
          String mapperClass = child.getStringAttribute("class");
          // attribute ç›®å‰åªèƒ½æ˜¯resource url class å…¶ä¸­ä¹‹ä¸€
          if (resource != null && url == null && mapperClass == null) {
            ErrorContext.instance().resource(resource);
            InputStream inputStream = Resources.getResourceAsStream(resource);
            XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());
            mapperParser.parse();
          } else if (resource == null && url != null && mapperClass == null) {
            ErrorContext.instance().resource(url);
            InputStream inputStream = Resources.getUrlAsStream(url);
            XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());
            mapperParser.parse();
          } else if (resource == null && url == null && mapperClass != null) {
            // è¿”å›å¯¹åº”Daoæ¥å£ Classå¯¹è±¡
            Class<?> mapperInterface = Resources.classForName(mapperClass);
            configuration.addMapper(mapperInterface);
          } else {
            throw new BuilderException("A mapper element may only specify a url, resource or class, but not more than one.");
          }
        }
      }
    }
  }
```
ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬é€‰æ‹©`resource == null && url == null && mapperClass != null`è¿™ä¸ªæ¡ä»¶åˆ†æ”¯ï¼ŒResouurces.classForNameè¿”å›daoæ¥å£ Classå¯¹è±¡ï¼Œç„¶åè°ƒç”¨configuration.addMapperæ–¹æ³•ï¼Œconfiguration.addMapperé‡Œè°ƒç”¨çš„æ˜¯mapperRegistry.addMapperæ–¹æ³•ï¼ŒåŠ å…¥åˆ°æ˜ å°„æ³¨å†Œæœºã€‚

```
MapperRegistry:
  
//å°†å·²ç»æ·»åŠ çš„æ˜ å°„éƒ½æ”¾å…¥HashMap
private final Map<Class<?>, MapperProxyFactory<?>> knownMappers = new HashMap<Class<?>, MapperProxyFactory<?>>();

public <T> void addMapper(Class<T> type) {
    //mapperå¿…é¡»æ˜¯æ¥å£ï¼æ‰ä¼šæ·»åŠ 
    if (type.isInterface()) {
      if (hasMapper(type)) {
        //å¦‚æœé‡å¤æ·»åŠ äº†ï¼ŒæŠ¥é”™
        throw new BindingException("Type " + type + " is already known to the MapperRegistry.");
      }
      boolean loadCompleted = false;
      try {
        // â‘ 
        knownMappers.put(type, new MapperProxyFactory<T>(type));
        // â‘¡æ³¨è§£è§£æå™¨ï¼Œä½†åŒæ—¶ä¹Ÿè¿›è¡Œäº†åŒçº§ç›®å½•ä¸‹dao.xmlçš„è§£æï¼Œå¦‚æœæ²¡æœ‰xmlæ–‡ä»¶ï¼Œåˆ™å»è§£ææ¥å£æ–¹æ³•ä¸Šçš„æ³¨è§£å†…å®¹ï¼Œå¦‚æœäºŒè€…çš†æœ‰ï¼ŒæŠ¥é”™ Mapped Statements collection already contains value for xx.xx.xx.xx
        MapperAnnotationBuilder parser = new MapperAnnotationBuilder(config, type);
        parser.parse();
        loadCompleted = true;
      } finally {
        //å¦‚æœåŠ è½½è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸éœ€è¦å†å°†è¿™ä¸ªmapperä»mybatisä¸­åˆ é™¤,è¿™ç§æ–¹å¼æ¯”è¾ƒä¸‘é™‹å§ï¼Œéš¾é“æ˜¯ä¸å¾—å·²è€Œä¸ºä¹‹ï¼Ÿ
        if (!loadCompleted) {
          knownMappers.remove(type);
        }
      }
    }
  }

```
â‘ åˆ›å»ºæ˜ å°„å™¨ä»£ç†å·¥å‚ï¼Œå¹¶åŠ å…¥åˆ°æ˜ å°„æ³¨å†Œæœºçš„kownMappers
â‘¡åœ¨æ³¨è§£è§£æå™¨çš„parse()æ–¹æ³•é‡Œå»æ¢æŸ¥åŒçº§ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨daoå¯¹åº”çš„xmlæ–‡ä»¶ã€‚
1ï¼‰å¦‚æœå­˜åœ¨ï¼Œåˆ™ä½¿ç”¨XMLMapperBuilderçš„parseæ–¹æ³•ï¼Œè§£ædaoå¯¹åº”çš„é…ç½®æ–‡ä»¶ä¸ºMappedStatementå®ä¾‹ï¼Œå°†è§£æå¥½çš„MappedStatementå®ä¾‹æ”¾å…¥configurationçš„mappedStatements Mapé‡Œï¼Œ`keyæ˜¯ç±»çš„å®Œå…¨é™å®šå+æ–¹æ³•åï¼Œvalueå°±æ˜¯MappedStatementå®ä¾‹`ã€‚

2ï¼‰å¦‚æœä¸å­˜åœ¨daoæ¥å£å¯¹åº”çš„xmlæ–‡ä»¶ï¼Œåˆ™å»åŠ è½½æ³¨è§£sqlã€‚

3ï¼‰å³å­˜åœ¨æ³¨è§£åˆåœ¨xmlé‡Œå­˜åœ¨å¯¹åº”çš„sqlæ ‡ç­¾ï¼Œä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸`java.lang.IllegalArgumentException` æç¤ºï¼š ` Mapped Statements collection already contains value for DAOç±»å.æ–¹æ³•å()`ã€‚

4ï¼‰å¦‚æœäºŒè€…çš†ä¸å­˜åœ¨ï¼Œå¯åŠ¨æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯åœ¨é¡¹ç›®é‡Œä½¿ç”¨æ—¶ï¼Œä¼šé€šè¿‡daoæ¥å£å®Œå…¨é™å®šå+æ–¹æ³•åæŸ¥æ‰¾sqlä¿¡æ¯ï¼Œæ²¡æœ‰æ‰¾åˆ°ä¼šæŠ›å‡º`Invalid bound statement (not found): cn.asae.e.contract.dao.ContractDao.æ–¹æ³•`

5ï¼‰ä»è¿™é‡Œæˆ‘ä»¬çŸ¥æ™“ï¼Œdaoæ¥å£é‡Œçš„æ–¹æ³•ä¸èƒ½é‡è½½ï¼Œå¦åˆ™ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸`java.lang.IllegalArgumentException` æç¤ºï¼š ` Mapped Statements collection already contains value for DAOç±»å.æ–¹æ³•å()`ã€‚
å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å»åŠ è½½æ–¹æ³•ä¸Šæ–¹æ³¨è§£ä¸­æ‰€å®šä¹‰çš„sqlç›¸å…³ä¿¡æ¯ã€‚
è€ŒMappedStatementé‡Œå­˜å‚¨ç€daoæ–¹æ³•å¯¹åº”çš„sqlæ‰€æœ‰ä¿¡æ¯ã€‚

ä»¥ä¸Šæ˜¯MyBatiså¯åŠ¨æ—¶ï¼Œéœ€è¦åšçš„å·¥ä½œï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬ä»…ä»…åªæ˜¯è®²äº†æœ€ä¸ºæ ¸å¿ƒçš„daoæ¥å£ä¸xmlçš„ç»‘å®šæ˜ å°„åŸç†ã€‚è€Œåšå®Œç»‘å®šæ˜ å°„ä¹‹åï¼Œæˆ‘ä»¬åœ¨å¯¹æ•°æ®åº“è¿›è¡Œcrudæ—¶ï¼Œåˆæ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢ï¼Ÿ

### 2ã€ä»`AuthorMapper authorMapper = sqlSession.getMapper(AuthorMapper.class);` å¼€å§‹è¯´èµ·

sqlSession.getMapperè¿”å›çš„æ˜¯AuthorMapperä»£ç†ç±»çš„å®ä¾‹ï¼Œå…¶å†…éƒ¨å®ç°ä¸ºï¼š
1ï¼‰è°ƒç”¨configuration.getMapper
2ï¼‰åœ¨configuration.getMapperé‡Œåˆè°ƒç”¨äº†ï¼ˆæ˜ å°„æ³¨å†Œæœºï¼‰mapperRegistry.getMapperï¼Œè¿˜æœ‰æ²¡æœ‰å°è±¡ï¼Œåœ¨MyBatisåˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬å°†daoçš„æ˜ å°„å™¨ä»£ç†å·¥å‚å®ä¾‹æ”¾å…¥åˆ°äº†æ˜ å°„æ³¨å†Œæœºé‡Œã€‚
3ï¼‰åœ¨mapperRegistry.getMapperæ–¹æ³•é‡Œå–å‡ºå¯¹åº”çš„æ˜ å°„å™¨ä»£ç†å·¥å‚ï¼Œç„¶åç”¨JDKåŠ¨æ€ä»£ç†ç”Ÿæˆä»£ç†ç±»å®ä¾‹è¿”å›ç»™ç”¨æˆ·ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
MapperRegistry:
public <T> T getMapper(Class<T> type, SqlSession sqlSession) {
    final MapperProxyFactory<T> mapperProxyFactory = (MapperProxyFactory<T>) knownMappers.get(type);
    if (mapperProxyFactory == null) {
      throw new BindingException("Type " + type + " is not known to the MapperRegistry.");
    }
    try {
      return mapperProxyFactory.newInstance(sqlSession);
    } catch (Exception e) {
      throw new BindingException("Error getting mapper instance. Cause: " + e, e);
    }
  }

MapperProxyFactory:
public class MapperProxyFactory<T> {

  private final Class<T> mapperInterface;
  private Map<Method, MapperMethod> methodCache = new ConcurrentHashMap<Method, MapperMethod>();

  public MapperProxyFactory(Class<T> mapperInterface) {
    this.mapperInterface = mapperInterface;
  }

  public Class<T> getMapperInterface() {
    return mapperInterface;
  }

  public Map<Method, MapperMethod> getMethodCache() {
    return methodCache;
  }

  // mapperProxyæ˜¯ä¸€ä¸ªå®ç°java.lang.reflect.InvocationHandleræ¥å£çš„ä»£ç†ç±»
  @SuppressWarnings("unchecked")
  protected T newInstance(MapperProxy<T> mapperProxy) {
    //ç”¨JDKè‡ªå¸¦çš„åŠ¨æ€ä»£ç†ç”Ÿæˆæ˜ å°„å™¨
    return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] { mapperInterface }, mapperProxy);
  }

  public T newInstance(SqlSession sqlSession) {
    final MapperProxy<T> mapperProxy = new MapperProxy<T>(sqlSession, mapperInterface, methodCache);
    return newInstance(mapperProxy);
  }

}
```
å°†ä»£ç†ç±»å®ä¾‹è¿”å›ç»™ç”¨æˆ·ä¹‹åï¼Œç”¨æˆ·è¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š
`List<E> list = author.getAuthors();`
å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ä»£ç†ç±»çš„invokeæ–¹æ³•ã€‚MapperProxyå¦‚ä¸‹ï¼š
```
public class MapperProxy<T> implements InvocationHandler, Serializable {

  private static final long serialVersionUID = -6424540398559729838L;
  private final SqlSession sqlSession;
  private final Class<T> mapperInterface;
  private final Map<Method, MapperMethod> methodCache;

  public MapperProxy(SqlSession sqlSession, Class<T> mapperInterface, Map<Method, MapperMethod> methodCache) {
    this.sqlSession = sqlSession;
    this.mapperInterface = mapperInterface;
    this.methodCache = methodCache;
  }

  // mybatis dao æ‰§è¡Œå¤„ç†æ ¸å¿ƒå…¥å£
  // Methodç±»ï¼Œä¸»è¦ç”¨äºåœ¨ç¨‹åºè¿è¡ŒçŠ¶æ€ä¸­ï¼ŒåŠ¨æ€åœ°è·å–æ–¹æ³•ä¿¡æ¯ï¼Œ args å‚æ•°
  @Override
  public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    try {
      // ä»£ç†ä»¥åï¼Œæ‰€æœ‰Mapperçš„æ–¹æ³•è°ƒç”¨æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨è¿™ä¸ªinvokeæ–¹æ³•
      // å¹¶ä¸æ˜¯ä»»ä½•ä¸€ä¸ªæ–¹æ³•éƒ½éœ€è¦æ‰§è¡Œè°ƒç”¨ä»£ç†å¯¹è±¡è¿›è¡Œæ‰§è¡Œï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯Objectä¸­é€šç”¨çš„æ–¹æ³•ï¼ˆtoStringã€hashCodeç­‰ï¼‰æ— éœ€æ‰§è¡Œ
      // æ–¹æ³•è¿”å›è¡¨ç¤ºå£°æ˜ç”±æ­¤Methodå¯¹è±¡è¡¨ç¤ºçš„æ–¹æ³•çš„ç±»çš„Classå¯¹è±¡
      if (Object.class.equals(method.getDeclaringClass())) {
        return method.invoke(this, args);
      } else if (isDefaultMethod(method)) {
        return invokeDefaultMethod(proxy, method, args);
      }
    } catch (Throwable t) {
      throw ExceptionUtil.unwrapThrowable(t);
    }
    final MapperMethod mapperMethod = cachedMapperMethod(method);
    return mapperMethod.execute(sqlSession, args);
  }

  private MapperMethod cachedMapperMethod(Method method) {
    // ç¬¬ä¸€æ¬¡è‚¯å®šä¸ºç©ºï¼Œä¹‹åç”±äºç¼“å­˜äº†ï¼Œæ‰€ä»¥é€Ÿåº¦åº”è¯¥ä¼šæœ‰æ‰€å¢åŠ 
    return methodCache.computeIfAbsent(method, k -> new MapperMethod(mapperInterface, method, sqlSession.getConfiguration()));
  }

  private Object invokeDefaultMethod(Object proxy, Method method, Object[] args)
      throws Throwable {
    final Constructor<MethodHandles.Lookup> constructor = MethodHandles.Lookup.class
        .getDeclaredConstructor(Class.class, int.class);
    if (!constructor.isAccessible()) {
      constructor.setAccessible(true);
    }
    final Class<?> declaringClass = method.getDeclaringClass();
    return constructor
        .newInstance(declaringClass,
            MethodHandles.Lookup.PRIVATE | MethodHandles.Lookup.PROTECTED
                | MethodHandles.Lookup.PACKAGE | MethodHandles.Lookup.PUBLIC)
        .unreflectSpecial(method, declaringClass).bindTo(proxy).invokeWithArguments(args);
  }

  /**
   * Backport of java.lang.reflect.Method#isDefault()
   */
  private boolean isDefaultMethod(Method method) {
    return (method.getModifiers()
        & (Modifier.ABSTRACT | Modifier.PUBLIC | Modifier.STATIC)) == Modifier.PUBLIC
        && method.getDeclaringClass().isInterface();
  }
}
```
1ï¼‰è¿‡æ»¤æ‰æ¥å£é»˜è®¤æ–¹æ³•åŠObjectä¸­é€šç”¨çš„æ–¹æ³•ï¼ŒçœŸæ­£æ‰§è¡Œçš„æ˜¯MapperMethod.executeæ–¹æ³•ã€‚
2ï¼‰MapperMethodå±æ€§æœ‰æ–¹æ³•ç­¾åã€sqlå‘½ä»¤ç›¸å…³ä¿¡æ¯ã€‚
3ï¼‰åœ¨å®ä¾‹åŒ–MaperMethodæ—¶ï¼Œé€šè¿‡daoçš„å®Œå…¨é™å®šå+æ–¹æ³•åæ‰¾åˆ°å¯¹åº”çš„MappedStatementå®ä¾‹ï¼Œ
å°†MappedStatementçš„idã€SqlCommandTypeèµ‹å€¼ç»™SqlCommondçš„ nameã€typeã€‚
4ï¼‰å½“æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œé€šè¿‡SqlCommondçš„name æ‰¾åˆ°MappedStatementï¼Œæ‰¾åˆ°sqlå¯¹åº”çš„sqlè¯­å¥ã€å‚æ•°ã€è¿”å›ç±»å‹ç­‰ç­‰ï¼Œç”±SqlSessionæäº¤åˆ°æ•°æ®åº“ï¼Œæ•°æ®è¿”å›åï¼Œé€šè¿‡åå°„è£…é…æ•°æ®ï¼Œè¿”å›ç»™ç”¨æˆ·ã€‚
MappedStatementé‡Œå­˜å‚¨ç€æˆ‘ä»¬sqlæ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚
çœ‹ä¸€ä¸‹MapperMethodçš„executeæ–¹æ³•
```
public Object execute(SqlSession sqlSession, Object[] args) {
    Object result;
    //å¯ä»¥çœ‹åˆ°æ‰§è¡Œæ—¶å°±æ˜¯4ç§æƒ…å†µï¼Œinsert|update|delete|selectï¼Œåˆ†åˆ«è°ƒç”¨SqlSessionçš„4å¤§ç±»æ–¹æ³•
    // SqlCommandTypeæ˜¯é€šè¿‡MappedStatementé‡Œå­˜å‚¨çš„sqlä¿¡æ¯ç¡®å®šçš„
    if (SqlCommandType.INSERT == command.getType()) {
      Object param = method.convertArgsToSqlCommandParam(args);
      result = rowCountResult(sqlSession.insert(command.getName(), param));
    } else if (SqlCommandType.UPDATE == command.getType()) {
      Object param = method.convertArgsToSqlCommandParam(args);
      result = rowCountResult(sqlSession.update(command.getName(), param));
    } else if (SqlCommandType.DELETE == command.getType()) {
      Object param = method.convertArgsToSqlCommandParam(args);
      result = rowCountResult(sqlSession.delete(command.getName(), param));
    } else if (SqlCommandType.SELECT == command.getType()) {
      if (method.returnsVoid() && method.hasResultHandler()) {
        //å¦‚æœæœ‰ç»“æœå¤„ç†å™¨
        executeWithResultHandler(sqlSession, args);
        result = null;
      } else if (method.returnsMany()) {
        //å¦‚æœç»“æœæœ‰å¤šæ¡è®°å½•
        result = executeForMany(sqlSession, args);
      } else if (method.returnsMap()) {
        //å¦‚æœç»“æœæ˜¯map
        result = executeForMap(sqlSession, args);
      } else {
        //å¦åˆ™å°±æ˜¯ä¸€æ¡è®°å½•
        Object param = method.convertArgsToSqlCommandParam(args);
        result = sqlSession.selectOne(command.getName(), param);
      }
    } else {
      throw new BindingException("Unknown execution method for: " + command.getName());
    }
    if (result == null && method.getReturnType().isPrimitive() && !method.returnsVoid()) {
      throw new BindingException("Mapper method '" + command.getName() 
          + " attempted to return null from a method with a primitive return type (" + method.getReturnType() + ").");
    }
    return result;
  }
```
é‡æ–°æ¢³ç†ä¸€ä¸‹è¿‡ç¨‹ï¼š
ä¸€ã€åœ¨MyBatisåˆå§‹åŒ–æ—¶ï¼ŒåŠ è½½å¹¶è§£æé…ç½®æ–‡ä»¶ï¼Œå°†daoä¿¡æ¯ä¸sqlé…ç½®æ–‡ä»¶è¿›è¡Œç»‘å®šæ˜ å°„åŠå…¶å®ƒé…ç½®ä¿¡æ¯çš„è§£æã€‚
Configurationå®ä¾‹å±æ€§mapperRegistry ä½¿ç”¨keyä¸ºdaoæ¥å£çš„å®Œå…¨é™å®šåï¼Œå­˜å‚¨æ˜ å°„å™¨ä»£ç†å·¥å‚å®ä¾‹ã€‚
Configurationå®ä¾‹å±æ€§mappedStatementsä½¿ç”¨keyä¸ºdaoæ¥å£çš„å®Œå…¨é™å®šå+æ–¹æ³•åï¼Œå­˜å‚¨MappedStatementå®ä¾‹ã€‚

äºŒã€åœ¨æ‰§è¡ŒæŸ¥è¯¢æ“ä½œæ—¶ï¼Œé€šè¿‡daoæ¥å£çš„å®Œå…¨é™å®šåå–å‡ºä»£ç†å·¥å‚å®ä¾‹ï¼Œç”±ä»£ç†å·¥å‚ç”Ÿäº§ä¸€ä¸ªdaoæ¥å£çš„ä»£ç†ç±»å®ä¾‹ï¼Œåœ¨ä»£ç†ç±»å®ä¾‹invokeæ–¹æ³•é‡Œé¢ï¼Œé€šè¿‡daoæ¥å£çš„å®Œå…¨é™å®šå+æ–¹æ³•åï¼Œå–å‡ºMappedStatementå®ä¾‹ï¼Œè¿›è¡Œå‚æ•°æ˜ å°„åå‘é€åˆ°æ•°æ®åº“ï¼Œæ•°æ®åº“è¿”å›ç»“æœåï¼Œæ ¹æ®MappedStatementå­˜å‚¨çš„ç»“æœé›†æ˜ å°„ç­–ç•¥ï¼Œè¿›è¡Œç»“æœé›†çš„è£…é…å¹¶è¿”å›ç»™ç”¨æˆ·ã€‚
å¢åˆ æ”¹ä¸€æ ·çš„é“ç†ã€‚

### äº”ã€å†™åœ¨æœ€åï¼š
1ã€çŸ¥è¯†ç‚¹ï¼š
åœ¨åˆšåˆšæ¢³ç†ä»£ç ä¸­ï¼Œæºç ä¸­æœ‰æ¶‰åŠåˆ°äº†å•ä¾‹æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼ï¼Œä»£ç†æ¨¡å¼ç­‰ç­‰å…¶å®ƒè®¾è®¡æ¨¡å¼ï¼Œå¸¦æ¥çš„å¥½å¤„å°±æ˜¯ä»£ç æ¸…æ™°ï¼Œç±»èŒè´£æ˜ç¡®ã€‚åŸºæœ¬ç¬¦åˆé«˜å†…èšã€ä½è€¦åˆã€‚

MyBatisçš„æ ¸å¿ƒå°±åœ¨äºé…ç½®æ–‡ä»¶è§£æå’Œsqlè¯­å¥æ˜ å°„è¿™ä¸€å—ï¼Œä¹Ÿæ˜¯ç²¾é«“æ‰€åœ¨ï¼Œå°¤å…¶æ˜¯åˆ©ç”¨jdkçš„ä»£ç†ï¼Œè¾¾åˆ°crudçš„æ“ä½œï¼Œå ªç§°ç”»é¾™ç‚¹ç›ä¹‹ç¬”ã€‚

2ã€ä¸ªäººå­˜ç–‘ï¼š
1ï¼‰ä½†æ˜¯æœ‰äº›åœ°æ–¹çš„ä»£ç å†™çš„æœ‰ç‚¹æ‘¸ä¸ç€å¤´è„‘ï¼Œå¦‚ä¸‹å›¾ã€‚
2ï¼‰å¹¶ä¸”å…¶ä¸­çš„ä¸€äº›ç±»ï¼Œå¦‚ï¼šMapperAnnotationBuilder å­˜åœ¨ç©¿æ’è§£ææ³¨è§£sqlå’Œxmlæ–‡ä»¶çš„é€»è¾‘ã€‚
3ï¼‰ä¸ºä»€ä¹ˆä¸æ”¯æŒdaoæ¥å£æ–¹æ³•é‡è½½ï¼Ÿ

![ç–‘æƒ‘çš„ä»£ç .png](https://upload-images.jianshu.io/upload_images/7190871-cf8d5cc167105e47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


æ€»å¾—æ¥è¯´ï¼ŒMyBatisæºç çš„åŠŸåº•è¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œå¯¹æˆ‘çš„å¯è¿ªä¸æ”¶è´§ä¹Ÿå¾ˆå¤§ã€‚æ„Ÿè°¢MyBatiså›¢é˜Ÿã€‚

### å…­ã€æ‹“å±•
å¦‚æœé¡¹ç›®å­˜åœ¨å¤šæ•°æ®æºï¼ŒSqlSessionFactoryå®ä¾‹å­˜åœ¨å‡ ä¸ªï¼Ÿæ˜¯é€šè¿‡ä»€ä¹ˆç¡®ä¿è¦æ“ä½œçš„DBå’Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„daoå¯¹åº”ä¸Šçš„å‘¢ï¼Ÿäº‹åŠ¡åˆæ˜¯å¦‚ä½•é…ç½®çš„ï¼Ÿ


